# Python code to load data.csv, count columns, and create a graph as output.png

import os
import sys

# Attempt to import required libraries
try:
    import pandas as pd
    import numpy as np
    import matplotlib
    matplotlib.use("Agg")  # Use non-interactive backend for saving figures
    import matplotlib.pyplot as plt
except ImportError as e:
    # If libraries are missing, raise to let the executor request installations
    raise

# 1) Load the CSV with encoding fallback
csv_path = "data.csv"
if not os.path.isfile(csv_path):
    print("Error: data.csv not found in the working directory.")
    sys.exit(1)

read_ok = False
last_err = None
for kwargs in ({}, {"encoding": "utf-8", "engine": "python"}, {"encoding": "latin1", "engine": "python"}):
    try:
        df = pd.read_csv(csv_path, **kwargs)
        read_ok = True
        break
    except Exception as e:
        last_err = e

if not read_ok:
    print(f"Error reading data.csv: {last_err}")
    sys.exit(1)

# 2) Compute number of columns
num_columns = df.shape[1]

# 3) Create a graph and save as output.png
plt.figure(figsize=(10, 6))
title_suffix = ""

# Select numeric columns
numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()

if len(numeric_cols) >= 1:
    col = numeric_cols[0]
    data = df[col].dropna().astype(float)
    if data.size == 0:
        # If numeric column exists but all NaN, fallback to categorical plot
        if df.shape[1] > 0:
            cat_col = df.columns[0]
            vc = df[cat_col].astype(str).value_counts().head(20)
            plt.bar(vc.index, vc.values, color="#1f77b4")
            plt.xticks(rotation=45, ha="right")
            plt.ylabel("Count")
            title_suffix = f"Bar chart of top categories in '{cat_col}' (numeric column empty)"
        else:
            plt.text(0.5, 0.5, "Empty DataFrame - no data to plot", ha='center', va='center')
            title_suffix = "No data available"
    else:
        plt.hist(data, bins=30, color="#1f77b4", edgecolor="white")
        plt.xlabel(col)
        plt.ylabel("Frequency")
        title_suffix = f"Histogram of numeric column '{col}'"
else:
    # No numeric columns, try categorical bar chart from the first column
    if df.shape[1] > 0:
        cat_col = df.columns[0]
        vc = df[cat_col].astype(str).value_counts().head(20)
        plt.bar(vc.index, vc.values, color="#1f77b4")
        plt.xticks(rotation=45, ha="right")
        plt.ylabel("Count")
        title_suffix = f"Bar chart of top 20 categories in '{cat_col}'"
    else:
        plt.text(0.5, 0.5, "Empty DataFrame - no data to plot", ha='center', va='center')
        title_suffix = "No data available"

plt.title(f"Overview Plot - {title_suffix}")
plt.tight_layout()
output_file = "output.png"
plt.savefig(output_file, dpi=150)
plt.close()

print(f"Task completed: Number of columns = {num_columns}. Graph saved as {output_file} ({title_suffix}).")
