# Analyze the number of males and females in data.csv

import sys

try:
    import pandas as pd
except ImportError as e:
    # pandas not installed; the executor will prompt us to install if needed
    print("Missing dependency: pandas. Please install it and rerun.")
    sys.exit(1)

import math

def classify_value(val, colname_lower):
    # Returns 'male', 'female', or None
    if pd.isna(val):
        return None

    # Handle booleans or numeric flags for 'is_male'
    if 'is_male' in colname_lower:
        if isinstance(val, bool):
            return 'male' if val else 'female'
        # Numeric or string numeric
        try:
            fval = float(val)
            if fval == 1:
                return 'male'
            if fval == 0:
                return 'female'
        except Exception:
            pass

    s = str(val).strip().lower()

    # Common male/female mappings
    male_set = {
        'male','m','man','men','boy','masc','masculino','masculine','homme','varon','varÃ³n','mr','sir'
    }
    female_set = {
        'female','f','woman','women','girl','fem','feminino','feminine','femme','femenino','mrs','ms','lady'
    }

    # Remove trailing punctuation
    s_clean = s.replace('.', '').replace(',', '').strip()

    if s_clean in male_set:
        return 'male'
    if s_clean in female_set:
        return 'female'

    # Handle common patterns like 'M/F' variations
    if s_clean in {'m/f','male/female','f/m','female/male'}:
        return None

    # Sometimes values like 'M ' or 'F ' or 'Male ' with spaces
    if s_clean[:1] in {'m','f'} and len(s_clean) == 1:
        return 'male' if s_clean == 'm' else 'female'

    return None

def evaluate_column(series, colname):
    col_lower = colname.lower()
    male = female = unknown = 0
    for v in series:
        lab = classify_value(v, col_lower)
        if lab == 'male':
            male += 1
        elif lab == 'female':
            female += 1
        else:
            unknown += 1
    return {'column': colname, 'male': male, 'female': female, 'unknown': unknown, 'labeled': male + female, 'total': len(series)}

def column_priority(name):
    n = name.lower()
    # Higher number = higher priority
    if 'gender' in n:
        return 3
    if 'sex' in n:
        return 2
    if 'is_male' in n or 'ismale' in n:
        return 1
    return 0

def main():
    try:
        df = pd.read_csv('data.csv')
    except FileNotFoundError:
        print("data.csv not found in the working directory.")
        sys.exit(1)
    except Exception as e:
        print(f"Error reading data.csv: {e}")
        sys.exit(1)

    if df.empty:
        print("The dataset is empty; cannot compute counts.")
        sys.exit(0)

    candidates = [c for c in df.columns if any(k in c.lower() for k in ['gender', 'sex', 'is_male', 'ismale'])]
    # If no obvious candidates, try all columns but will only accept those producing labeled > 0
    search_cols = candidates if candidates else list(df.columns)

    evaluations = []
    for col in search_cols:
        eval_res = evaluate_column(df[col], col)
        if eval_res['labeled'] > 0:
            evaluations.append(eval_res)

    if not evaluations:
        print("Could not find a column with male/female information.")
        sys.exit(0)

    # Choose the best column: max labeled, then by priority, then by name
    evaluations.sort(key=lambda x: (x['labeled'], column_priority(x['column']), x['column']), reverse=True)
    best = evaluations[0]

    # Output results
    print(f"Detected gender/sex column: {best['column']}")
    print(f"Total rows: {best['total']}")
    print(f"Males: {best['male']}")
    print(f"Females: {best['female']}")
    if best['unknown'] > 0:
        print(f"Unclassified/other/missing: {best['unknown']}")
    print("Task completed: Counted males and females from the detected column.")

if __name__ == "__main__":
    main()
